
##CPU使用率高之二

   今天早上得到用户的反馈，我们服务响应慢：原本固定的30秒一个心跳，服务器在三个心跳时间（90秒）以后才返回心跳数据包既三个心跳响应包一起发送至客户端。
   原本是怀疑网络的情况，但是服务都是部署在阿里云上的而且从使用情况来看带宽都还比较稳定。于是打算看一下CPU的使用情况，
   具体的命令在[Kafka broker cpu使用率过高](/2017-03-18-Kafka broker CPU使用率过高.md)中有提及。或者使用`ps -Lfp pid`和`top -Hp pid`也能看到个线程对CPU的占用时间
   
   ![使用top -Hp截图](/assets/images/2017-11-21-top.png)
   
   通过上图可以看到线程1620-1627的TIME明显高于其他的线程。然后使用jstack查看是哪些线程。结果是这8个线程都是netty的eventloop（`"nioEventLoopGroup-3-1" #28 prio=10 os_prio=0 tid=0x00007fc934007000 nid=0x654 runnable`），这样的结果也好理解，因为socket服务的通信本身就很繁忙占用CUP资源高也是常理之中，但是我发现其中好几个线程的信息都涉及到了数据库的一张表，由此我们考虑到是不是数据库的问题导致表数据操作耗时较大，这张表数据已经有近30万条的数据，但是代码中查询操作涉及到的属性上并没有索引，同时也从运维的同事那里得到反馈，数据库服务器的CPU使用率一直处于较高的水平。最后我们在表的一些关键属性上加了索引，数据CPU才下降了许多，socket服务也比原来顺畅了许多。